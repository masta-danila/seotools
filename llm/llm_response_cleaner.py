import json
import re


def clean_llm_content(raw_content: str) -> str:
    """
    Принимает строку, которую может вернуть LLM (нейросеть) и которая
    потенциально содержит JSON, обёрнутый в ```json ... ``` и прочие
    вспомогательные символы. Возвращает «очищенную» строку — либо
    корректный JSON (в текстовом виде), либо исходный текст без обёрток.
    """

    if not isinstance(raw_content, str):
        return raw_content

    # Удаляем ```json и ``` в начале/конце
    content_without_backticks = re.sub(r'^```[a-zA-Z]*', '', raw_content)
    content_without_backticks = re.sub(r'```$', '', content_without_backticks)
    content_without_backticks = content_without_backticks.strip()

    # Убираем лишние \n, оставляя их внутри JSON
    content_without_backticks = re.sub(r'(?<!\\)\n+', ' ', content_without_backticks)


    try:
        parsed_json = json.loads(content_without_backticks)
        return json.dumps(parsed_json, ensure_ascii=False, indent=4)
    except json.JSONDecodeError:
        return content_without_backticks


# Пример использования
if __name__ == "__main__":
    #raw_data = '```json\n{"text": "0: Алло.\\n1: Алло, Михаил, здравствуйте.\\n0: Здравствуйте.\\n1: Роман отдает права. Вот вы заявку оставили на продвижение у вас на сайте, все верно?\\n0: Да, да.\\n1: Вот хотел у вас пару моментов уточнить. Вам сейчас удобно пару минут?\\n0: Да, да.\\n1: Вы, к сожалению, не указали сайт. Не могли бы назвать ваш домен, чтобы я посмотрел, можно ли продвинуть его в топ?\\n0: Угу, посмотрите, пожалуйста, сайт aerozolk.ru.\\n1: Так, аэрозоль...\\n0: Klub.ru, с «k» как доллар.\\n1: Да, сейчас. Ну, я думаю, найду сейчас.\\n0: Посвященное производству аэрозолей, а именно...\\n1: Угу.\\n0: Поставки комплектующих и оборудования. То есть мы, это наш бизнес.\\n1: Да, клапаны, вот все вижу.\\n0: Ну да, да, да, да, да. То есть мы поставляем комплектующие в России, не производят и оборудование, в России производят китайское оборудование.\\n1: Угу, так...\\n0: Российское оборудование для производства аэрозолей. Вот рынок у нас очень узкий и специфичный, и всего таких игроков четверо.\\n1: Угу.\\n0: Сайтов на эту тему штук девять.\\n1: На всю Россию вы имеете в виду, вот на...\\n0: Да, на всю Россию.\\n1: Угу, угу.\\n0: Штук девять всего сайтов, ага, извините, вот штук десять сайтов.\\n1: Да, будьте здоровы, угу.\\n0: Причем пять — это наших сайтов, и это одна из проблем, поскольку они информационно пересекаются и посвящены аэрозолям.\\n1: Угу.\\n0: Вот какую задачу нам нужно решить. Вот этот сайт, аэрозоль клапан существует более двадцати лет, был на старом движке, мы на Новый год поменяли движок, и сайт упал в поисковиках, не слышно и не видно. Вот какие-то вещи, связанные с, не знаю, с ограничением посещения сайта, с какими-то ссылками, они в общем-то не очень интересны, потому что опять же специфика такова, что производителей не так уж и много в России и основная задача — это когда человек вдруг решит собраться производить аэрозоли, забив какие-то слова, он увидел в топе наш сайт, в общем-то и все, то есть нам нужно продвижение.\\n1: У, ну когда бизнес планирует...\\n0: По запросам и вернуть сайт на топовую позицию, как он был все эти годы.\\n1: Это можно сделать, да, это достаточно...\\n0: Вот.\\n1: Близко, можно помочь. Вот у вас вот пресс...\\n0: Ну и какие-то рекомендации, поскольку текстовка других сайтов она тоже с этим переплетается, но может быть есть какие-то ошибки, пока делали новый сайт, все это вот нужно посмотреть и дать рекомендации, ну и какой-то бюджет определить.\\n1: Да, вот, да, давайте так...\\n0: Что делаем и как стоит...\\n1: Вот этот момент, вы на подъезд переехали, да, получается?\\n0: Да, да, да, да.\\n1: В чем причина падения? Дело в том, что когда делается новая версия сайта, а у вас он кардинально отличался от старого, то есть структура другая, там дизайн, то есть вы прям поменяли...\\n0: Ну, конечно, да, все другое, да.\\n1: Да, вот, то есть в чем суть? Вот когда у вас был старый сайт, у него были там разные урлы, допустим, aerozolk.ru, там о нас, например, комплектующие, там, ну, то есть разные вот эти ссылки, и получается, когда вы выкатили новую версию сайта, старую вы снесли бездиректора, то есть директ это когда старые ссылки сохраняются и просто переадресовываются на новые, то есть вы создали новый раздел, который раньше не существовал.\\n0: Угу.\\n1: Вот и вес старого раздела позволяет этой новой странице быть в топе. Вот поэтому наша задача вернуть позиции, то есть когда так происходит, нужно сделать эту работу, то есть прежде всего...\\n0: Угу.\\n1: Проверить индексацию страниц, то есть на каких местах вы сейчас находитесь, то есть если вы откатились на вторую страницу, то есть первое место упали там, не знаю, на двадцатое место, например.\\n0: Не, ну, сороковое, примерно так.\\n1: А вы смотрели по топвизору или по каким-то другим инструментам?\\n0: Нет, по тем словам, которые обычно...\\n1: Вводите.\\n0: Делаем, да, да, да, верно.\\n1: Да, ничего страшного, сороковое место, например, да, то есть четвертое где-то, да, вот если искать, ну, например, тут в чем успех быстроты возвращения результата? То есть мы собираем вот эти посадочные страницы, исправляем ошибки, потому что ошибки, они, ну, в любом случае есть, да, это в плане тегов потому что вам делали сайт, наверное, просто программисты, да, которые сайтами занимаются, то есть они не сеошники, просто делали свою работу, чтобы у вас сайт открывался, работал, ну, грубо говоря, как вы хотели его.\\n0: Конечно, конечно.\\n1: Вот, мы вот эти ошибки правим, то есть я вам делаю аудит, могу завтра его подготовить, прислать, если будет время, можем пройтись, то есть и мы подключим поведенческий фактор, соответственно, поведенческий фактор он дает результат, ну, по сути, моментально, то есть мы за один месяц вас вернем на первые позиции, которые вы потеряете, вот.\\n0: Угу.\\n1: По доработкам у вас есть человек, кто занимается поддержкой сайта, ну, то есть работы какие-то вносит?\\n0: Нет, нет, нет.\\n1: Понял.\\n0: Нет.\\n1: Так, а вы смотрели позиции по Москве или по всей России? Вот раньше вы были прям...\\n0: Да нет, я гугл, этот самый яндекс забил и себя не нашел. Ну вот печаль.\\n1: А, понял, понял, так а ранее? Вот вы эти результаты сами по себе получили или были сеошники у вас когда давно на старом сайте?\\n0: Да нет, нет, нет, а ранее, вы имеете в виду? Нет, вы поймите, что рынок настолько...\\n1: Да, узкий.\\n0: Своеобразный специфичный, да, что там других-то игроков-то и нет. Вот и по тематике бизнеса мы представляем заводы европейские, а наши конкуренты — это вот три компании, да, которые еще есть.\\n1: Угу.\\n0: Они эпизодически вводят в Китай.\\n1: У.\\n0: Вот и, соответственно, вся наша конкуренция идет, это за людей, которые неужели сейчас производят аэрозоли, тут все понятно, а за перспективы, которые вдруг решили, что бы мне, например, не сделать, я не знаю, краску или смазку, да?\\n1: У.\\n0: Вот, я хочу это сделать, и вот когда он обращается, соответственно, мы уже в этих разделах не фигурируем, там вот по словам, например, там клапаны аэрозольные или производство аэрозоли, да, если напротив производства аэрозоли, вроде это близко к нам, поскольку он говорит про комплектующие оборудование, но...\\n1: У.\\n0: Поисковики подгрузят туда все заводы России, и, соответственно, мы будем сразу на сороковых местах, то есть, ну, разные слова и разные действия поисковиков, а в общем-то нам нужно присутствовать.\\n1: Ну, да, да.\\n0: По всем этим словам, да, вот.\\n1: Без проблем, ну, это в принципе проще сделать с нуля, допустим, у вас хотя бы есть какой, ну, вы упали, но проще оттолкнуться с тех позиций, где вы сейчас находитесь. А еще вот, Михаил, вы бы могли мне написать, вот я вам сейчас в WhatsApp тоже напишу...\\n0: Ну, да, чисто деск, угу.\\n1: Примеры запросов, которые вам наиболее важны, можно даже несколько или там списком.\\n0: Да, хорошо, да.\\n1: Вот так. Это сейчас я вам как раз написал в WhatsApp, чтобы у вас сохранился контакт. По бюджету хотел у вас уточнить.\\n0: Ну, пока слабо себе представляем эту тему.\\n1: Ну, вы угу.\\n0: Вот, вы обозначьте, какие есть варианты, ну, что-то будем думать, выбирать.\\n1: Ну, у вас узкая, узкая тематика, да, просто, ну...\\n0: Крайне узкая, да.\\n1: Тут нужно индивидуальное предложение, потому что, ну, банально наши тарифы вы, наверное, видели на сайте, да, когда вот...\\n0: Ну, да, да, как.\\n1: Вот, то есть...\\n0: Да.\\n1: По факту я попытаюсь согласовать индивидуальные условия, потому что, ну, бот у вас меньше, чем другим проектам, но тут в чем фишка?\\n0: Да, верно.\\n1: СЕО надо.\\n0: И способ продвижения, наверное, разные я так понимаю будут.\\n1: Да, да, да, да, но тут фишка в чем? Итого, что Яндекс там меняет постоянно алгоритмы, надо все равно, ну, работать постоянно с сайтом, чтобы он держался, потому что мы вас можем там вывести быстро, но сайт может потом упасть со временем опять же, вот. То есть тут все вот, работа постоянная.\\n0: Угу.\\n1: Плюс я не знаю, ну, какие-то доработки будем делать, то есть если вы хотите там что-то добавить, текст убрать, картинку, то есть это тоже как бы важная вещь, то есть чтобы можно было.\\n0: Ну, или тексты переработать, для того чтобы поисковикам было как бы удобнее.\\n1: Да, да, да, вот поэтому по бюджетам, ну, если делать с доработками, ну бюджет может быть в районе, наверное, семидесяти тысяч где-то будет, вот.\\n0: Угу.\\n1: Такой вообще бюджет планировали рассматривать на данную задачу?\\n0: Ну, поменьше чуть-чуть, там, в размере там пятидесяти тысяч, да.\\n1: Понял, ну я могу обсудить индивидуально.\\n0: Ну и если вы аргументируете, да, я схожу к собственнику компании, может быть он скажет, ну, да, нормально, давайте, просто пока масса трагедии, надо понять, да и объем сотрудничества, чем нам это грозит.\\n1: Угу.\\n0: Или, может быть, это там сделать два раза, ну, в течение там двух месяцев как-то, ну, не знаю, то есть, ну, вы предложите, пока программа-то не ясна, да, что делаем, как идем и сколько это стоит.\\n1: Ну, оттолкнемся от аудита, то что надо понять, да, почта проблемы, вот вы сейчас запросы пришлете, которые вас интересуют, ну, мы еще соберем, понятное дело, потому что люди по-разному вводят, ну, которые вас беспокоят прежде всего.\\n0: Да, понятно.\\n1: Вот, и я не знаю, либо завтра, либо в понедельник мы с вами уже обсудим эти детали, вот, и дальше уже, если там цена руководства и вас устроит, тоже скажу, что нужно там для начала работы. Вот доступ от сайта у вас, я так понимаю, есть, то есть все, в принципе...\\n0: Да.\\n1: Нам позволит вносить изменения, все, я понял вас, тогда будем на связи, вот.\\n0: Да, хорошо.\\n1: Да, до свидания.\\n0: Хорошо, да, всего доброго.\\n",\n"manager_id": 1}\n```'
    raw_data = '{\n"text": "1: Здравствуйте, это Сергей, компания АдвертПро.\\n0: Добрый день, меня тоже Сергей зовут. Скажите пожалуйста, вы занимаетесь, да, созданием и продвижением сайтов там?\\n1: Да, все верно.\\n0: Такой вот... А скажите, сейчас вот смотрите, у нас есть сайт нашей компании, вот мы хотим его обновить, не знаю, может создать заново его, я не знаю, как это правильно сказать.\\n1: А давайте посмотрим, как, как, как домен называется?\\n0: Так, асфальтстрой.\\n1: Угу, так.\\n0: В конце буковка "j".\\n1: Сейчас. Asphaltstroy.ru, да?\\n0: Асфальт... a-s-f-a-l-t, строй.\\n1: Так, a-s-f...\\n0: Нет, a-s-f.\\n1: Угу.\\n0: a-l-t.\\n1: a-l-t.\\n0: s-t-r.\\n1: s-t-r.\\n0: \'O\', "j" в конце, точка ru.\\n1: j. Сейчас что-то такое не находит. Так, давайте тогда на WhatsApp вам напишу, вы мне тогда напишите домен, мы более детально посмотрим. И подскажите, пожалуйста, у вас на какой платформе вообще сайт сейчас?\\n0: Да я в этом, думаете, разбираюсь?\\n1: А, я понял вас, хорошо. И конкретно почему решили перенести и поменять?\\n0: Ну давно не обновляли, ничего не делали, как бы обновить сайт, добавить информацию.\\n1: Я понял вас. А по бюджету у вас понимание есть?\\n0: Честно, вообще не знаю. Смотря что нужно делать, если сказать, что мне понятно. Чем дешевле тем лучше будет, ну как бы понятно. Тебе не надо делать тоже.\\n1: Угу, смотрите, просто если вы, опять же, сайт у вас есть, на данный момент вы хотите его перерабатывать. Вот сейчас ваш действующий сайт какую роль выполняет, то есть вы его под контекст даете?\\n0: Ну, привлекает, ну мы используем его, да, в Директе, в контекстной рекламе.\\n1: Я понял.\\n0: Он нам, ну, клиентов привлекает, информацию у нас предоставляет.\\n1: Угу, угу, я понял вас, да. Соответственно, а впоследствии вот вы сайт, да, делаете. Что хотели бы делать? Именно под SEO его продвигать?\\n0: Ну то же самое, чтобы оставалось. Нет, не под SEO продвижение, а обновить информацию, ну сделать дизайн, изменить дизайн, вот такую вот работу сделать.\\n1: Угу, я понял.\\n0: Ну, своего рода апгрейд, что ли, не знаю, сайта.\\n1: Я понял вас, ну и впоследствии продолжать Директ на него давать.\\n0: Само собой. Директ, может, я его не все его продвижение делали раньше, но сейчас не делаем. Может, опять SEO продвижение будем делать, но пока это так в далеких планах.\\n1: Я понял вас. Так, давайте начнем с того, что вы мне сайт пришлете, я тогда посмотрю и перезвоню вам, и вариант предложу, какие варианты есть вообще. Может быть, сайт просто пока я его не вижу, не могу вам сказать.\\n0: Ну напишите мне на WhatsApp тогда.\\n1: Может там космические большие доработки нужны, может там чуть-чуть подправить, и тогда ваш предмет с вами пообщаемся. Сейчас на WhatsApp напишу, отправьте, я посмотрю и перезвоню вам там в течение 15 минут, хорошо?\\n0: Да, добро.\\n1: Угу.\\n",\n"manager_id": 1\n}'
    cleaned = clean_llm_content(raw_data)
    print(cleaned)
