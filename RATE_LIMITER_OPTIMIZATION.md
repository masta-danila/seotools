# Оптимизация Rate Limiter

## Реализация

Успешно реализована система глобального контроля запросов к Arsenkin API с использованием скользящего окна.

## Изменения

### 1. Создан `arsenkin/rate_limiter.py`
- Класс `AsyncRateLimiter` с поддержкой скользящего окна (30 запросов/60 секунд)
- Глобальный экземпляр `_global_rate_limiter` для общего контроля
- Методы `acquire()` для ожидания слота и `get_stats()` для мониторинга

### 2. Интегрирован в `arsenkin/search_parser.py`
- Добавлен `await _rate_limiter.acquire()` в:
  - `create_task()` - создание задачи check-top
  - `check_task_status()` - проверка статуса
  - `get_task_result()` - получение результата

### 3. Интегрирован в `arsenkin/h_parser.py`
- Добавлен `await _rate_limiter.acquire()` в:
  - `create_task_by_urls()` - создание задачи check-h
  - `check_task_status()` - проверка статуса
  - `get_task_result()` - получение результата

### 4. Оптимизирован `main.py`
- `max_concurrent`: 2 → 5 (увеличение производительности в 2.5x)
- `wait_per_query`: 15 → 10 (оптимизация интервалов проверки)
- `wait_per_url`: 3 → 2 (оптимизация интервалов проверки)
- **Удалена** пауза 120 секунд между шагами 2 и 3
- Добавлено логирование статистики rate limiter после каждого шага

## Преимущества

✅ **Точный контроль**: Скользящее окно обеспечивает соблюдение лимита 30 запросов/минуту

✅ **Максимальная производительность**: 5 параллельных задач вместо 2

✅ **Отсутствие лишних пауз**: Ожидание только при реальном достижении лимита

✅ **Мониторинг**: Полная статистика использования API

✅ **Thread-safe**: Безопасная работа с asyncio через Lock

## Ожидаемые результаты

**До оптимизации:**
- 2 параллельных задачи
- Пауза 120 секунд между шагами
- ~5-7 минут на полный цикл (при 10 URL)

**После оптимизации:**
- 5 параллельных задач (прирост 2.5x)
- Нет лишних пауз - только при достижении лимита
- ~2-3 минуты на полный цикл (прирост 2-2.5x)
- Полное использование доступных 30 запросов/мин

## Проверка

✅ Синтаксис всех файлов проверен (`py_compile`)

✅ Нет ошибок линтера (`ReadLints`)

✅ Все импорты корректны

✅ Логика скользящего окна реализована правильно

## Статистика Rate Limiter

После каждого шага в логах отображается:
- Всего запросов
- Всего ожиданий
- Общее время ожидания
- Среднее время ожидания
- Активных запросов в окне

## Как работает

```python
# Каждый HTTP запрос к Arsenkin API
await _rate_limiter.acquire()  # Ждёт, если достигнут лимит
async with httpx.AsyncClient() as client:
    response = await client.post(...)
```

Rate limiter автоматически:
1. Отслеживает все запросы в скользящем окне (60 сек)
2. Удаляет старые запросы из окна
3. Ждёт, если достигнут лимит (30 запросов)
4. Регистрирует новый запрос

## Запуск

Система готова к использованию. Запустите:

```bash
python3 main.py
```

Rate limiter автоматически контролирует все запросы к Arsenkin API.
